<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue3 Gantt å®Œæ•´åŠŸèƒ½ç¤ºä¾‹</title>

  <!-- å¼•å…¥ Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- å¼•å…¥ä¾èµ–åº“ -->
  <script src="https://unpkg.com/dayjs@1.11.13/dayjs.min.js"></script>
  <script src="https://unpkg.com/@vueuse/core@11.3.0/index.iife.min.js"></script>
  <script src="https://unpkg.com/interactjs@1.10.27/dist/interact.min.js"></script>
  <script src="https://unpkg.com/svg.js@2.7.1/dist/svg.min.js"></script>

  <!-- å¼•å…¥ Gantt ç»„ä»¶æ ·å¼ -->
  <link rel="stylesheet" href="./dist/vue3-gantt.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f8f8;
    }

    #app {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .demo-header {
      background: linear-gradient(145deg, #f5f5f5, #e8e8e8);
      border-bottom: 1px solid #d0d0d0;
      padding: 16px 24px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .demo-header h1 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }

    .demo-header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: #666;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .metro-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      border: 1px solid #d0d0d0;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      color: #666666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 2px;
      transition: all 0.2s;
    }

    .metro-btn:hover {
      background: linear-gradient(145deg, #f5f5f5, #e8e8e8);
      color: #333333;
    }

    .metro-btn-primary {
      background: linear-gradient(145deg, #0078d4, #106ebe) !important;
      color: #ffffff !important;
    }

    .metro-btn-primary:hover {
      background: linear-gradient(145deg, #106ebe, #005a9e) !important;
    }

    .gantt-wrapper {
      flex: 1;
      overflow: hidden;
    }

    /* æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .task-dialog {
      background: #ffffff;
      border-radius: 4px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid #e0e0e0;
      background: linear-gradient(145deg, #f5f5f5, #e8e8e8);
    }

    .dialog-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #333333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #666666;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #333333;
    }

    .dialog-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #555555;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d0d0d0;
      border-radius: 2px;
      font-size: 14px;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0078d4;
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }

    .dialog-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #e0e0e0;
      background: #f8f8f8;
    }

    /* æ¶ˆæ¯æç¤º */
    .message-toast {
      position: fixed;
      top: 80px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
      min-width: 280px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .message-toast.success {
      background: #107c10;
      color: #ffffff;
      border-left: 4px solid #0b5a0b;
    }

    .message-toast.error {
      background: #d83b01;
      color: #ffffff;
      border-left: 4px solid #a72700;
    }

    .message-toast.warning {
      background: #ffb900;
      color: #333333;
      border-left: 4px solid #d39300;
    }

    .section-divider {
      text-align: center;
      margin: 24px 0 20px;
      position: relative;
    }

    .section-divider span {
      background: #ffffff;
      padding: 0 16px;
      color: #666666;
      font-size: 14px;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }

    .section-divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #d0d0d0;
      z-index: 0;
    }

    .required-mark {
      color: #d83b01;
      font-weight: bold;
      margin-left: 4px;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- å¤´éƒ¨ -->
    <div class="demo-header">
      <div>
        <h1>ğŸ¯ Vue3 Gantt å®Œæ•´åŠŸèƒ½ç¤ºä¾‹</h1>
        <p>âœ… è‡ªå®šä¹‰å­—æ®µ | âœ… ä»»åŠ¡ç¼–è¾‘ | âœ… è¡¨å•éªŒè¯ | âœ… åˆ—æ˜¾ç¤ºè®¾ç½®</p>
      </div>
      <div class="header-actions">
        <button class="metro-btn metro-btn-primary" @click="openAddRootTaskDialog">
          + æ–°å»ºæ ¹ä»»åŠ¡
        </button>
        <button class="metro-btn" @click="openCustomFieldsDialog">
          âš™ è‡ªå®šä¹‰å­—æ®µ
        </button>
      </div>
    </div>

    <!-- ç”˜ç‰¹å›¾ -->
    <div class="gantt-wrapper">
      <gantt
        :style-config="styleConfig"
        :data-config="dataConfig"
        :event-config="eventConfig">
      </gantt>
    </div>

    <!-- ä»»åŠ¡ç¼–è¾‘å¯¹è¯æ¡† -->
    <div v-if="showTaskDialog" class="modal-overlay" @click.self="closeTaskDialog">
      <div class="task-dialog">
        <div class="dialog-header">
          <h2>{{ isEditMode ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ–°å»ºä»»åŠ¡' }}</h2>
          <button class="close-btn" @click="closeTaskDialog">Ã—</button>
        </div>
        <div class="dialog-body">
          <div class="form-group">
            <label>ä»»åŠ¡åç§° <span class="required-mark">*</span></label>
            <input v-model="taskForm.taskNo" type="text" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" />
          </div>
          <div class="form-group">
            <label>ä¼˜å…ˆçº§</label>
            <select v-model="taskForm.level">
              <option value="ç´§æ€¥">ç´§æ€¥</option>
              <option value="é‡è¦">é‡è¦</option>
              <option value="ä¸€èˆ¬">ä¸€èˆ¬</option>
              <option value="ä¸é‡è¦">ä¸é‡è¦</option>
            </select>
          </div>
          <div class="form-group">
            <label>å¼€å§‹æ—¶é—´ <span class="required-mark">*</span></label>
            <input v-model="taskForm.start_date" type="datetime-local" />
          </div>
          <div class="form-group">
            <label>ç»“æŸæ—¶é—´ <span class="required-mark">*</span></label>
            <input v-model="taskForm.end_date" type="datetime-local" />
          </div>
          <div class="form-group">
            <label>è¿›åº¦ (0-1)</label>
            <input v-model.number="taskForm.job_progress" type="number" min="0" max="1" step="0.1" />
          </div>

          <!-- è‡ªå®šä¹‰å­—æ®µ -->
          <div v-if="customFields.length > 0">
            <div class="section-divider">
              <span>è‡ªå®šä¹‰å­—æ®µ</span>
            </div>
            <div v-for="field in customFields" :key="field.id" class="form-group">
              <label>
                {{ field.label }}
                <span v-if="field.required" class="required-mark">*</span>
              </label>

              <!-- æ–‡æœ¬ -->
              <input v-if="field.type === 'text'"
                     v-model="taskForm.customFieldValues[field.id]"
                     type="text"
                     :placeholder="field.placeholder || `è¯·è¾“å…¥${field.label}`"
                     :required="field.required" />

              <!-- æ•°å­— -->
              <input v-else-if="field.type === 'number'"
                     v-model.number="taskForm.customFieldValues[field.id]"
                     type="number"
                     :placeholder="field.placeholder || `è¯·è¾“å…¥${field.label}`"
                     :required="field.required" />

              <!-- æ—¥æœŸ -->
              <input v-else-if="field.type === 'date'"
                     v-model="taskForm.customFieldValues[field.id]"
                     type="date"
                     :required="field.required" />

              <!-- ä¸‹æ‹‰é€‰æ‹© -->
              <select v-else-if="field.type === 'select'"
                      v-model="taskForm.customFieldValues[field.id]"
                      :required="field.required">
                <option value="">è¯·é€‰æ‹©{{ field.label }}</option>
                <option v-for="option in field.options" :key="option" :value="option">
                  {{ option }}
                </option>
              </select>

              <!-- å¤šè¡Œæ–‡æœ¬ -->
              <textarea v-else-if="field.type === 'textarea'"
                        v-model="taskForm.customFieldValues[field.id]"
                        :placeholder="field.placeholder || `è¯·è¾“å…¥${field.label}`"
                        :required="field.required"
                        rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="dialog-footer">
          <button class="metro-btn" @click="closeTaskDialog">å–æ¶ˆ</button>
          <button class="metro-btn metro-btn-primary" @click="saveTask">
            {{ isEditMode ? 'ä¿å­˜' : 'åˆ›å»º' }}
          </button>
        </div>
      </div>
    </div>

    <!-- è‡ªå®šä¹‰å­—æ®µç®¡ç†å¯¹è¯æ¡†ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
    <div v-if="showCustomFieldsDialog" class="modal-overlay" @click.self="closeCustomFieldsDialog">
      <div class="task-dialog">
        <div class="dialog-header">
          <h2>è‡ªå®šä¹‰å­—æ®µç®¡ç†</h2>
          <button class="close-btn" @click="closeCustomFieldsDialog">Ã—</button>
        </div>
        <div class="dialog-body">
          <p style="color: #666; margin-bottom: 20px;">
            ğŸ’¡ æç¤ºï¼šåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ‚¨å¯ä»¥æ·»åŠ æ–‡æœ¬ã€æ•°å­—ã€æ—¥æœŸã€ä¸‹æ‹‰é€‰æ‹©ç­‰å¤šç§ç±»å‹çš„è‡ªå®šä¹‰å­—æ®µã€‚
            æ­¤ç¤ºä¾‹å·²é¢„è®¾äº†"è´Ÿè´£äºº"å­—æ®µä½œä¸ºæ¼”ç¤ºã€‚
          </p>
          <div v-if="customFields.length > 0">
            <h3 style="margin: 0 0 12px 0; font-size: 14px;">å·²æ·»åŠ çš„å­—æ®µï¼š</h3>
            <div v-for="field in customFields" :key="field.id"
                 style="padding: 12px; background: #f8f8f8; margin-bottom: 8px; border-radius: 4px;">
              <strong>{{ field.label }}</strong>
              <span style="color: #666; font-size: 12px;"> - {{ getFieldTypeLabel(field.type) }}</span>
            </div>
          </div>
        </div>
        <div class="dialog-footer">
          <button class="metro-btn metro-btn-primary" @click="closeCustomFieldsDialog">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div v-if="message" :class="['message-toast', message.type]">
      {{ message.text }}
    </div>
  </div>

  <!-- å¼•å…¥ Gantt ç»„ä»¶ UMD åŒ… -->
  <script src="./dist/vue3-gantt.umd.js"></script>

  <script>
    const { createApp } = Vue;
    const Gantt = Vue3Gantt.default || Vue3Gantt.Gantt;
    const LinkType = Vue3Gantt.LinkType || {
      FINISH_TO_START: 0,
      START_TO_START: 1,
      FINISH_TO_FINISH: 2,
      START_TO_FINISH: 3
    };

    const app = createApp({
      components: {
        Gantt
      },
      data() {
        const today = dayjs();
        const currentMonth = today.format('YYYY-MM');
        const startOfMonth = today.startOf('month').format('YYYY-MM-DD');
        const endOfMonth = today.endOf('month').format('YYYY-MM-DD');

        return {
          // å¯¹è¯æ¡†çŠ¶æ€
          showTaskDialog: false,
          showCustomFieldsDialog: false,
          isEditMode: false,
          isRootTask: false,

          // ä»»åŠ¡è¡¨å•
          taskForm: {
            id: null,
            pid: '0',
            taskNo: '',
            level: 'ä¸€èˆ¬',
            start_date: today.format('YYYY-MM-DDTHH:mm'),
            end_date: today.add(1, 'day').format('YYYY-MM-DDTHH:mm'),
            job_progress: 0,
            spend_time: null,
            customFieldValues: {}
          },

          // æ¶ˆæ¯æç¤º
          message: null,

          // è‡ªå®šä¹‰å­—æ®µï¼ˆé¢„è®¾ä¸€ä¸ª"è´Ÿè´£äºº"å­—æ®µä½œä¸ºç¤ºä¾‹ï¼‰
          customFields: [
            {
              id: 'field-assignee',
              label: 'è´Ÿè´£äºº',
              type: 'text',
              placeholder: 'è¯·è¾“å…¥è´Ÿè´£äººå§“å',
              required: true,
              options: []
            }
          ],

          // æ ·å¼é…ç½®
          styleConfig: {
            headersHeight: 100,
            rowHeight: 60,
            setBarColor: (row) => {
              const colorMap = {
                'ç´§æ€¥': '#e74c3c',
                'é‡è¦': '#3498db',
                'ä¸€èˆ¬': '#95a5a6',
                'ä¸é‡è¦': '#f39c12'
              };
              return colorMap[row.level] || '#333333';
            }
          },

          // æ•°æ®é…ç½®
          dataConfig: {
            queryStartDate: startOfMonth,
            queryEndDate: endOfMonth,
            dataSource: [],
            dependencies: [],
            mapFields: {
              id: 'id',
              parentId: 'pid',
              task: 'taskNo',
              priority: 'level',
              startdate: 'start_date',
              enddate: 'end_date',
              takestime: 'spend_time',
              progress: 'job_progress'
            },
            taskHeaders: [
              { title: 'id', width: 100, property: 'id', show: false },
              { title: 'çˆ¶id', width: 100, property: 'parentId', show: false },
              { title: 'åºå·', width: 160, property: 'no', show: true, fixed: true },
              { title: 'ä»»åŠ¡åç§°', width: 190, property: 'task', show: true },
              { title: 'ä¼˜å…ˆçº§', width: 90, property: 'priority', show: true },
              { title: 'å¼€å§‹æ—¶é—´', width: 150, property: 'startdate', show: true },
              { title: 'ç»“æŸæ—¶é—´', width: 150, property: 'enddate', show: true },
              { title: 'è€—æ—¶', width: 90, property: 'takestime', show: true },
              // è‡ªå®šä¹‰å­—æ®µï¼šè´Ÿè´£äºº
              { title: 'è´Ÿè´£äºº', width: 120, property: 'customField_field-assignee', show: true }
            ]
          },

          // äº‹ä»¶é…ç½®
          eventConfig: {
            addRootTask: () => {
              this.openAddRootTaskDialog();
            },
            addSubTask: (row) => {
              this.openAddSubTaskDialog(row.id);
            },
            removeTask: (row) => {
              this.removeTask(row.id);
            },
            editTask: (row) => {
              this.openEditTaskDialog(row.id);
            },
            updateProgress: (detail) => {
              const task = this.dataConfig.dataSource.find(t => t.id === detail.taskId);
              if (task) {
                task.job_progress = String(detail.newProgress);
                this.showMessage('è¿›åº¦æ›´æ–°æˆåŠŸ', 'success');
              }
            },
            queryTask: (startDate, endDate, mode) => {
              this.loadInitialData();
            },
            barDate: (id, startDate, endDate) => {
              const task = this.dataConfig.dataSource.find(t => t.id === id);
              if (task) {
                task.start_date = startDate;
                task.end_date = endDate;
                this.showMessage('ä»»åŠ¡æ—¥æœŸæ›´æ–°æˆåŠŸ', 'success');
              }
            },
            allowChangeTaskDate: (allow) => {
              console.log('å…è®¸æ”¹å˜ä»»åŠ¡æ—¥æœŸ:', allow);
            }
          }
        };
      },
      methods: {
        // åŠ è½½åˆå§‹æ•°æ®
        loadInitialData() {
          const currentMonth = dayjs().format('YYYY-MM');

          // æ¨¡æ‹Ÿåç«¯è¿”å›çš„ä»»åŠ¡æ•°æ®ï¼ˆåŒ…å«è‡ªå®šä¹‰å­—æ®µå€¼ï¼‰
          const tasks = [
            {
              id: '1',
              pid: '0',
              taskNo: 'é¡¹ç›®è§„åˆ’é˜¶æ®µ',
              level: 'é‡è¦',
              start_date: `${currentMonth}-01 08:00:00`,
              end_date: `${currentMonth}-06 18:00:00`,
              job_progress: '0.85',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'å¼ ä¸‰'
              }
            },
            {
              id: '2',
              pid: '1',
              taskNo: 'éœ€æ±‚åˆ†æ',
              level: 'ç´§æ€¥',
              start_date: `${currentMonth}-01 08:00:00`,
              end_date: `${currentMonth}-02 18:00:00`,
              job_progress: '1.0',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'æå››'
              }
            },
            {
              id: '3',
              pid: '1',
              taskNo: 'æŠ€æœ¯é€‰å‹',
              level: 'é‡è¦',
              start_date: `${currentMonth}-03 08:00:00`,
              end_date: `${currentMonth}-04 18:00:00`,
              job_progress: '0.9',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'ç‹äº”'
              }
            },
            {
              id: '4',
              pid: '1',
              taskNo: 'æ¶æ„è®¾è®¡',
              level: 'é‡è¦',
              start_date: `${currentMonth}-05 08:00:00`,
              end_date: `${currentMonth}-06 18:00:00`,
              job_progress: '0.7',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'èµµå…­'
              }
            },
            {
              id: '5',
              pid: '0',
              taskNo: 'å¼€å‘é˜¶æ®µ',
              level: 'é‡è¦',
              start_date: `${currentMonth}-07 08:00:00`,
              end_date: `${currentMonth}-18 18:00:00`,
              job_progress: '0.5',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'é’±ä¸ƒ'
              }
            },
            {
              id: '6',
              pid: '5',
              taskNo: 'å‰ç«¯å¼€å‘',
              level: 'é‡è¦',
              start_date: `${currentMonth}-07 08:00:00`,
              end_date: `${currentMonth}-13 18:00:00`,
              job_progress: '0.6',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'å­™å…«'
              }
            },
            {
              id: '7',
              pid: '5',
              taskNo: 'åç«¯å¼€å‘',
              level: 'é‡è¦',
              start_date: `${currentMonth}-10 08:00:00`,
              end_date: `${currentMonth}-18 18:00:00`,
              job_progress: '0.5',
              spend_time: null,
              customFieldValues: {
                'field-assignee': 'å‘¨ä¹'
              }
            }
          ];

          // å¤„ç†è‡ªå®šä¹‰å­—æ®µï¼šå°† customFieldValues å±•å¼€åˆ°é¡¶å±‚
          this.dataConfig.dataSource = tasks.map(task => {
            const processedTask = { ...task };
            if (task.customFieldValues) {
              this.customFields.forEach(field => {
                const value = task.customFieldValues[field.id];
                if (value !== undefined) {
                  processedTask[`customField_${field.id}`] = value;
                }
              });
            }
            return processedTask;
          });

          // ä»»åŠ¡ä¾èµ–å…³ç³»
          this.dataConfig.dependencies = [
            { sourceTaskId: '2', targetTaskId: '3', type: LinkType.FINISH_TO_START },
            { sourceTaskId: '3', targetTaskId: '4', type: LinkType.FINISH_TO_START },
            { sourceTaskId: '1', targetTaskId: '5', type: LinkType.FINISH_TO_START },
            { sourceTaskId: '6', targetTaskId: '7', type: LinkType.START_TO_START }
          ];
        },

        // æ‰“å¼€æ–°å»ºæ ¹ä»»åŠ¡å¯¹è¯æ¡†
        openAddRootTaskDialog() {
          this.isEditMode = false;
          this.isRootTask = true;
          this.taskForm = {
            id: null,
            pid: '0',
            taskNo: '',
            level: 'ä¸€èˆ¬',
            start_date: dayjs().format('YYYY-MM-DDTHH:mm'),
            end_date: dayjs().add(1, 'day').format('YYYY-MM-DDTHH:mm'),
            job_progress: 0,
            spend_time: null,
            customFieldValues: {}
          };
          this.showTaskDialog = true;
        },

        // æ‰“å¼€æ–°å»ºå­ä»»åŠ¡å¯¹è¯æ¡†
        openAddSubTaskDialog(parentId) {
          this.isEditMode = false;
          this.isRootTask = false;
          const parentTask = this.dataConfig.dataSource.find(t => t.id === parentId);
          this.taskForm = {
            id: null,
            pid: parentId,
            taskNo: '',
            level: 'ä¸€èˆ¬',
            start_date: parentTask ? parentTask.start_date.replace(' ', 'T').slice(0, 16) : dayjs().format('YYYY-MM-DDTHH:mm'),
            end_date: parentTask ? parentTask.end_date.replace(' ', 'T').slice(0, 16) : dayjs().add(1, 'day').format('YYYY-MM-DDTHH:mm'),
            job_progress: 0,
            spend_time: null,
            customFieldValues: {}
          };
          this.showTaskDialog = true;
        },

        // æ‰“å¼€ç¼–è¾‘ä»»åŠ¡å¯¹è¯æ¡†
        openEditTaskDialog(taskId) {
          this.isEditMode = true;
          this.isRootTask = false;
          const task = this.dataConfig.dataSource.find(t => t.id === taskId);
          if (task) {
            this.taskForm = {
              id: task.id,
              pid: task.pid,
              taskNo: task.taskNo,
              level: task.level,
              start_date: task.start_date.replace(' ', 'T').slice(0, 16),
              end_date: task.end_date.replace(' ', 'T').slice(0, 16),
              job_progress: parseFloat(task.job_progress),
              spend_time: task.spend_time,
              customFieldValues: task.customFieldValues || {}
            };
            this.showTaskDialog = true;
          }
        },

        // å…³é—­ä»»åŠ¡å¯¹è¯æ¡†
        closeTaskDialog() {
          this.showTaskDialog = false;
        },

        // ä¿å­˜ä»»åŠ¡
        saveTask() {
          // ç®€å•éªŒè¯
          if (!this.taskForm.taskNo.trim()) {
            this.showMessage('ä»»åŠ¡åç§°ä¸èƒ½ä¸ºç©º', 'error');
            return;
          }

          // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
          const formatDate = (dateStr) => {
            return dayjs(dateStr).format('YYYY-MM-DD HH:mm:ss');
          };

          const taskData = {
            ...this.taskForm,
            start_date: formatDate(this.taskForm.start_date),
            end_date: formatDate(this.taskForm.end_date),
            job_progress: String(this.taskForm.job_progress)
          };

          if (this.isEditMode && this.taskForm.id) {
            // æ›´æ–°ä»»åŠ¡
            const index = this.dataConfig.dataSource.findIndex(t => t.id === this.taskForm.id);
            if (index !== -1) {
              const updatedTask = { ...this.dataConfig.dataSource[index], ...taskData };

              // å¤„ç†è‡ªå®šä¹‰å­—æ®µ
              if (updatedTask.customFieldValues) {
                this.customFields.forEach(field => {
                  const value = updatedTask.customFieldValues[field.id];
                  if (value !== undefined) {
                    updatedTask[`customField_${field.id}`] = value;
                  }
                });
              }

              this.dataConfig.dataSource[index] = updatedTask;
              // å¼ºåˆ¶è§¦å‘å“åº”å¼æ›´æ–°
              this.dataConfig.dataSource = [...this.dataConfig.dataSource];
              this.showMessage('ä»»åŠ¡æ›´æ–°æˆåŠŸ', 'success');
            }
          } else {
            // æ–°å¢ä»»åŠ¡
            const newTask = {
              id: `task-${Date.now()}`,
              ...taskData
            };

            // å¤„ç†è‡ªå®šä¹‰å­—æ®µ
            if (newTask.customFieldValues) {
              this.customFields.forEach(field => {
                const value = newTask.customFieldValues[field.id];
                if (value !== undefined) {
                  newTask[`customField_${field.id}`] = value;
                }
              });
            }

            this.dataConfig.dataSource.push(newTask);
            this.showMessage('ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
          }

          this.closeTaskDialog();
        },

        // åˆ é™¤ä»»åŠ¡
        removeTask(taskId) {
          if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤æ‰€æœ‰å­ä»»åŠ¡ï¼')) {
            const deleteTaskAndChildren = (id) => {
              const children = this.dataConfig.dataSource.filter(t => t.pid === id);
              children.forEach(child => deleteTaskAndChildren(child.id));
              this.dataConfig.dataSource = this.dataConfig.dataSource.filter(t => t.id !== id);
            };

            deleteTaskAndChildren(taskId);
            this.showMessage('ä»»åŠ¡åˆ é™¤æˆåŠŸ', 'success');
          }
        },

        // æ‰“å¼€è‡ªå®šä¹‰å­—æ®µå¯¹è¯æ¡†
        openCustomFieldsDialog() {
          this.showCustomFieldsDialog = true;
        },

        // å…³é—­è‡ªå®šä¹‰å­—æ®µå¯¹è¯æ¡†
        closeCustomFieldsDialog() {
          this.showCustomFieldsDialog = false;
        },

        // è·å–å­—æ®µç±»å‹æ ‡ç­¾
        getFieldTypeLabel(type) {
          const labels = {
            text: 'æ–‡æœ¬',
            number: 'æ•°å­—',
            date: 'æ—¥æœŸ',
            datetime: 'æ—¥æœŸæ—¶é—´',
            select: 'ä¸‹æ‹‰é€‰æ‹©',
            textarea: 'å¤šè¡Œæ–‡æœ¬',
            checkbox: 'å¤é€‰æ¡†'
          };
          return labels[type] || type;
        },

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        showMessage(text, type = 'success') {
          this.message = { text, type };
          setTimeout(() => {
            this.message = null;
          }, 3000);
        }
      },
      mounted() {
        // åŠ è½½åˆå§‹æ•°æ®
        setTimeout(() => {
          if (this.eventConfig.queryTask) {
            this.eventConfig.queryTask(
              this.dataConfig.queryStartDate,
              this.dataConfig.queryEndDate,
              'æœˆ'
            );
          }
        }, 100);
      }
    });

    app.mount('#app');
  </script>
</body>

</html>
